<!DOCTYPE html>
<html>

<head>
    <title>Question Paper Generator</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>

<body>
    <h2>Generate Question Paper</h2>

    <div style="display: flex; gap: 15px; margin-bottom: 20px;">

        <a href="{{ url_for('add_info') }}">
            <button type="button">Add Publication</button>
        </a>

        <a href="{{ url_for('add_question') }}">
            <button type="button">Add Question</button>
        </a>

        <a href="{{ url_for('rename_page') }}">
            <button type="button">Rename Publication</button>
        </a>

        <a href="{{ url_for('rename_question') }}">
            <button type="button"> update Question</button>
        </a>

    </div>

    <br><br>
    <form method="POST" action="/generate" id="question-form">

        <!-- Publication Dropdown -->
        <label>Publication:</label>
        <select name="publication" id="publication" required>
            <option value="">Select Publication</option>
            {% for pub in publications %}
            <option value="{{ pub }}">{{ pub }}</option>
            {% endfor %}
        </select>
        <br><br>

        <!-- Subject Dropdown -->
        <label>Subject:</label>
        <select name="subject" id="subject" required disabled>
            <option value="">Select Subject</option>
        </select>
        <br><br>

        <!-- Class Dropdown -->
        <label>Class:</label>
        <select name="class" id="class" required disabled>
            <option value="">Select Class</option>
        </select>
        <br><br>

        <!-- Chapters Checkboxes -->
        <div id="chapters-container">
            <label>Chapters:</label>
            <div id="chapters-list">
                <!-- Dynamically loaded checkboxes -->
            </div>
        </div>
        <br>

        <h4>Select Number of Questions and Marks</h4>

        <!-- Question Type Inputs -->
        {% set question_types = [
        ['Fill in the Blanks', 'fill'],
        ['True/False', 'tf'],
        ['Match the Following', 'match'],
        ['Choose the Best Answer', 'best'],
        ['Full Form', 'fullform'],
        ['Answer the Following', 'ans']
        ] %}

        {% for label, key in question_types %}
        <label>{{ label }}:</label><br>
        Questions: <input type="number" name="{{ key }}_count" value="5" min="0" class="count" data-type="{{ key }}">
        Marks per question: <input type="number" name="{{ key }}_mark" value="1" min="0" class="mark"
            data-type="{{ key }}"><br><br>
        {% endfor %}

        <!-- Manual Questions Section -->
        <label>Manual Questions:</label><br>
        <textarea name="manual_questions" rows="6" cols="40"
            placeholder="Write questions one per line..."></textarea><br><br>

        <label>Marks per Manual Question:</label><br>
        <input type="number" name="manual_mark" value="2" min="0" class="mark" data-type="manual"><br><br>

        <strong>Total Marks:</strong> <span id="total-marks">0</span> Marks<br><br>

        <button type="submit">Generate Question Paper</button>

    </form>




    <!-- Total Marks Calculation Script -->
    <script>
        function calculateTotalMarks() {
            let total = 0;
            const types = ["fill", "tf", "match", "best", "ans", "fullform", "manual"];

            types.forEach(type => {
                const count = parseInt(document.querySelector(`[data-type="${type}"].count`)?.value) || 0;
                const mark = parseInt(document.querySelector(`[data-type="${type}"].mark`)?.value) || 0;
                total += count * mark;
            });

            document.getElementById('total-marks').innerText = total;
        }

        document.querySelectorAll('.count, .mark').forEach(input => {
            input.addEventListener('input', calculateTotalMarks);
        });

        window.addEventListener('DOMContentLoaded', calculateTotalMarks);
    </script>

    <!-- Dynamic Dropdowns and Chapters Loader -->
    <script>
        $(document).ready(function () {

            // When publication changes
            $('#publication').change(function () {
                const pub = $(this).val();
                $('#subject').prop('disabled', true).html('<option>Loading...</option>');
                $('#class').prop('disabled', true).html('<option>Select Class</option>');
                $('#chapters-list').html('');

                if (pub) {
                    $.getJSON('/get_subjects/' + encodeURIComponent(pub), function (data) {
                        let options = '<option value="">Select Subject</option>';
                        $.each(data.subjects, function (i, val) {
                            options += `<option value="${val}">${val}</option>`;
                        });
                        $('#subject').html(options).prop('disabled', false);
                    });
                }
            });

            // When subject changes
            $('#subject').change(function () {
                const pub = $('#publication').val();
                const sub = $(this).val();
                $('#class').prop('disabled', true).html('<option>Loading...</option>');
                $('#chapters-list').html('');

                if (pub && sub) {
                    $.getJSON(`/get_classes/${encodeURIComponent(pub)}/${encodeURIComponent(sub)}`, function (data) {
                        let options = '<option value="">Select Class</option>';
                        $.each(data.classes, function (i, val) {
                            options += `<option value="${val}">${val}</option>`;
                        });
                        $('#class').html(options).prop('disabled', false);
                    });
                }
            });

            // When class changes
            $('#class').change(function () {
                const pub = $('#publication').val();
                const sub = $('#subject').val();
                const cls = $(this).val();
                $('#chapters-list').html('Loading chapters...');

                if (pub && sub && cls) {
                    $.getJSON(`/get_chapters/${encodeURIComponent(pub)}/${encodeURIComponent(sub)}/${encodeURIComponent(cls)}`, function (data) {
                        if (data.chapters.length > 0) {
                            let html = '';
                            $.each(data.chapters, function (i, val) {
                                html += `<input type="checkbox" name="chapters" value="${val}" id="ch${i}"> 
                                         <label for="ch${i}">${val}</label><br>`;
                            });
                            $('#chapters-list').html(html);
                        } else {
                            $('#chapters-list').html('No chapters found.');
                        }
                    });
                }
            });

        });
    </script>
</body>

</html>